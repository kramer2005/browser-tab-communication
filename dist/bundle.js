(()=>{"use strict";const e=class{constructor(e,n){this.peerConnection=e,this.id=n}set onmessage(e){this.dataChannel.onmessage=e}send(e){this.dataChannel.send(e)}},n={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let t;const a=new Uint8Array(16);function s(){if(!t&&(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!t))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(a)}const i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));const o=function(e,t,a){if(n.randomUUID&&!t&&!e)return n.randomUUID();const o=(e=e||{}).random||(e.rng||s)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t){a=a||0;for(let e=0;e<16;++e)t[a+e]=o[e];return t}return function(e,n=0){return i[e[n+0]]+i[e[n+1]]+i[e[n+2]]+i[e[n+3]]+"-"+i[e[n+4]]+i[e[n+5]]+"-"+i[e[n+6]]+i[e[n+7]]+"-"+i[e[n+8]]+i[e[n+9]]+"-"+i[e[n+10]]+i[e[n+11]]+i[e[n+12]]+i[e[n+13]]+i[e[n+14]]+i[e[n+15]]}(o)};var d=function(e,n,t,a){return new(t||(t=Promise))((function(s,i){function o(e){try{c(a.next(e))}catch(e){i(e)}}function d(e){try{c(a.throw(e))}catch(e){i(e)}}function c(e){var n;e.done?s(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(o,d)}c((a=a.apply(e,n||[])).next())}))};class c{static getInstance(e){return c.instance||(c.instance=new c(e)),c.instance}constructor(e){this.tabs=[],this.id=o(),this.broadcast=new BroadcastChannel(e||`tab-communication-${window.location.hostname}`),this.broadcast.onmessage=e=>{const{data:n}=e;switch(n.type){case"sync":this.handleSync(n);break;case"offer":this.handleOffer(n);break;case"answer":this.handleAnswer(n);break;case"candidate":this.handleCandidate(n);break;case"close":this.handleClosing(n)}},window.addEventListener("load",(()=>{this.broadcast.postMessage({type:"sync",clientId:this.id})})),window.addEventListener("beforeunload",(()=>{this.broadcast.postMessage({type:"close",clientId:this.id})}))}handleSync(e){return d(this,void 0,void 0,(function*(){const n=this.createTab(e.clientId),t=n.peerConnection,a=t.createDataChannel("dataChannel");n.dataChannel=a,a.onopen=()=>{var e;return null===(e=this.onTabOpen)||void 0===e?void 0:e.call(this,n)};const s=yield t.createOffer();this.broadcast.postMessage({type:"offer",sdp:s.sdp,dealerId:this.id,clientId:e.clientId}),yield t.setLocalDescription(s)}))}handleOffer(e){return d(this,void 0,void 0,(function*(){if(e.clientId!==this.id)return;const n=this.createTab(e.dealerId),t=n.peerConnection;t.ondatachannel=e=>{n.dataChannel=e.channel,e.channel.onopen=()=>{var e;return null===(e=this.onTabOpen)||void 0===e?void 0:e.call(this,n)}},yield t.setRemoteDescription(e);const a=yield t.createAnswer();yield t.setLocalDescription(a),this.broadcast.postMessage({type:"answer",sdp:a.sdp,dealerId:e.dealerId,clientId:e.clientId})}))}handleAnswer(e){var n;return d(this,void 0,void 0,(function*(){e.dealerId===this.id&&(null===(n=this.tabs.find((n=>n.id===e.clientId)))||void 0===n||n.peerConnection.setRemoteDescription(e))}))}handleCandidate(e){var n;if(e.candidate){if(e.clientId!==this.id)return;null===(n=this.tabs.find((n=>n.id===e.dealerId)))||void 0===n||n.peerConnection.addIceCandidate(e)}}handleClosing(e){var n;const t=this.tabs.find((n=>n.id===e.clientId));t&&(this.tabs=this.tabs.filter((e=>e!==t)),null===(n=this.onTabClose)||void 0===n||n.call(this,t),t.peerConnection.close())}createTab(n){const t=new RTCPeerConnection;t.onicecandidate=e=>{e.candidate&&this.broadcast.postMessage({type:"candidate",candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex,dealerId:this.id,clientId:n})};const a=new e(t,n);return t.onconnectionstatechange=e=>{var n;"connected"!==t.connectionState&&"connecting"!==t.connectionState&&(this.tabs=this.tabs.filter((e=>e!==a)),null===(n=this.onTabClose)||void 0===n||n.call(this,a),t.close())},this.tabs.push(a),a}get openTabs(){return this.tabs.filter((e=>"open"===e.dataChannel.readyState))}broadcastMessage(e){this.openTabs.forEach((n=>n.send(e)))}}const r=c;r.getInstance(),r.getInstance().onTabOpen=e=>e.onmessage=e=>console.log(e.data),document.querySelector("#Send").onclick=()=>{r.getInstance().openTabs[0].send("Hello World!")}})();