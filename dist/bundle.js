(()=>{"use strict";const n=class{constructor(n,e){this.peerConnection=n,this.id=e}set onmessage(n){this.dataChannel.onmessage=n}send(n){this.dataChannel.send(n)}},e={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let t;const a=new Uint8Array(16);function i(){if(!t&&(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!t))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(a)}const s=[];for(let n=0;n<256;++n)s.push((n+256).toString(16).slice(1));const d=function(n,t,a){if(e.randomUUID&&!t&&!n)return e.randomUUID();const d=(n=n||{}).random||(n.rng||i)();if(d[6]=15&d[6]|64,d[8]=63&d[8]|128,t){a=a||0;for(let n=0;n<16;++n)t[a+n]=d[n];return t}return function(n,e=0){return s[n[e+0]]+s[n[e+1]]+s[n[e+2]]+s[n[e+3]]+"-"+s[n[e+4]]+s[n[e+5]]+"-"+s[n[e+6]]+s[n[e+7]]+"-"+s[n[e+8]]+s[n[e+9]]+"-"+s[n[e+10]]+s[n[e+11]]+s[n[e+12]]+s[n[e+13]]+s[n[e+14]]+s[n[e+15]]}(d)};var o=function(n,e,t,a){return new(t||(t=Promise))((function(i,s){function d(n){try{c(a.next(n))}catch(n){s(n)}}function o(n){try{c(a.throw(n))}catch(n){s(n)}}function c(n){var e;n.done?i(n.value):(e=n.value,e instanceof t?e:new t((function(n){n(e)}))).then(d,o)}c((a=a.apply(n,e||[])).next())}))};class c{static getInstance(n){return c.instance||(c.instance=new c(n)),c.instance}constructor(n){this._tabs=[],this.id=d(),this.broadcastChannel=new BroadcastChannel(n||`tab-communication-${window.location.hostname}`),this.broadcastChannel.onmessage=n=>{const{data:e}=n;switch(e.type){case"sync":this.handleSync(e);break;case"offer":this.handleOffer(e);break;case"answer":this.handleAnswer(e);break;case"candidate":this.handleCandidate(e);break;case"close":this.handleClosing(e)}},window.addEventListener("load",(()=>{this.broadcastChannel.postMessage({type:"sync",clientId:this.id})})),window.addEventListener("beforeunload",(()=>{this.broadcastChannel.postMessage({type:"close",clientId:this.id})}))}handleSync(n){return o(this,void 0,void 0,(function*(){const e=this.createTab(n.clientId),t=e.peerConnection,a=t.createDataChannel("dataChannel");e.dataChannel=a,a.onopen=()=>{var n;return null===(n=this.onTabOpen)||void 0===n?void 0:n.call(this,e)};const i=yield t.createOffer();this.broadcastChannel.postMessage({type:"offer",sdp:i.sdp,dealerId:this.id,clientId:n.clientId}),yield t.setLocalDescription(i)}))}handleOffer(n){return o(this,void 0,void 0,(function*(){if(n.clientId!==this.id)return;const e=this.createTab(n.dealerId),t=e.peerConnection;t.ondatachannel=n=>{e.dataChannel=n.channel,n.channel.onopen=()=>{var n;return null===(n=this.onTabOpen)||void 0===n?void 0:n.call(this,e)}},yield t.setRemoteDescription(n);const a=yield t.createAnswer();yield t.setLocalDescription(a),this.broadcastChannel.postMessage({type:"answer",sdp:a.sdp,dealerId:n.dealerId,clientId:n.clientId})}))}handleAnswer(n){var e;return o(this,void 0,void 0,(function*(){n.dealerId===this.id&&(null===(e=this._tabs.find((e=>e.id===n.clientId)))||void 0===e||e.peerConnection.setRemoteDescription(n))}))}handleCandidate(n){var e;if(n.candidate){if(n.clientId!==this.id)return;null===(e=this._tabs.find((e=>e.id===n.dealerId)))||void 0===e||e.peerConnection.addIceCandidate(n)}}handleClosing(n){var e;const t=this._tabs.find((e=>e.id===n.clientId));t&&(this._tabs=this._tabs.filter((n=>n!==t)),null===(e=this.onTabClose)||void 0===e||e.call(this,t),t.peerConnection.close())}createTab(e){const t=new RTCPeerConnection;t.onicecandidate=n=>{n.candidate&&this.broadcastChannel.postMessage({type:"candidate",candidate:n.candidate.candidate,sdpMid:n.candidate.sdpMid,sdpMLineIndex:n.candidate.sdpMLineIndex,dealerId:this.id,clientId:e})};const a=new n(t,e);return t.onconnectionstatechange=n=>{var e;"connected"!==t.connectionState&&"connecting"!==t.connectionState&&(this._tabs=this._tabs.filter((n=>n!==a)),null===(e=this.onTabClose)||void 0===e||e.call(this,a),t.close())},this._tabs.push(a),a}get tabs(){return this._tabs.filter((n=>"open"===n.dataChannel.readyState))}broadcast(n){this.tabs.forEach((e=>e.send(n)))}}c.getInstance()})();