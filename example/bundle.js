(()=>{"use strict";const e=class{constructor(e,n){this.peerConnection=e,this.id=n}set onmessage(e){this.dataChannel.onmessage=e}send(e){this.dataChannel.send(e)}},n={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let t;const a=new Uint8Array(16);function d(){if(!t&&(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!t))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(a)}const i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));const s=function(e,t,a){if(n.randomUUID&&!t&&!e)return n.randomUUID();const s=(e=e||{}).random||(e.rng||d)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){a=a||0;for(let e=0;e<16;++e)t[a+e]=s[e];return t}return function(e,n=0){return i[e[n+0]]+i[e[n+1]]+i[e[n+2]]+i[e[n+3]]+"-"+i[e[n+4]]+i[e[n+5]]+"-"+i[e[n+6]]+i[e[n+7]]+"-"+i[e[n+8]]+i[e[n+9]]+"-"+i[e[n+10]]+i[e[n+11]]+i[e[n+12]]+i[e[n+13]]+i[e[n+14]]+i[e[n+15]]}(s)};var o=function(e,n,t,a){return new(t||(t=Promise))((function(d,i){function s(e){try{c(a.next(e))}catch(e){i(e)}}function o(e){try{c(a.throw(e))}catch(e){i(e)}}function c(e){var n;e.done?d(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(s,o)}c((a=a.apply(e,n||[])).next())}))};class c{static getInstance(e){return c.instance||(c.instance=new c(e)),c.instance}constructor(e){this._tabs=[],this.id=s(),this.broadcastChannel=new BroadcastChannel(e||`tab-communication-${window.location.hostname}`),this.broadcastChannel.onmessage=e=>{const{data:n}=e;switch(n.type){case"sync":this.handleSync(n);break;case"offer":this.handleOffer(n);break;case"answer":this.handleAnswer(n);break;case"candidate":this.handleCandidate(n);break;case"close":this.handleClosing(n)}},window.addEventListener("load",(()=>{this.broadcastChannel.postMessage({type:"sync",clientId:this.id})})),window.addEventListener("beforeunload",(()=>{this.broadcastChannel.postMessage({type:"close",clientId:this.id})}))}handleSync(e){return o(this,void 0,void 0,(function*(){const n=this.createTab(e.clientId),t=n.peerConnection,a=t.createDataChannel("dataChannel");n.dataChannel=a,a.onopen=()=>{var e;return null===(e=this.onTabOpen)||void 0===e?void 0:e.call(this,n)};const d=yield t.createOffer();this.broadcastChannel.postMessage({type:"offer",sdp:d.sdp,dealerId:this.id,clientId:e.clientId}),yield t.setLocalDescription(d)}))}handleOffer(e){return o(this,void 0,void 0,(function*(){if(e.clientId!==this.id)return;const n=this.createTab(e.dealerId),t=n.peerConnection;t.ondatachannel=e=>{n.dataChannel=e.channel,e.channel.onopen=()=>{var e;return null===(e=this.onTabOpen)||void 0===e?void 0:e.call(this,n)}},yield t.setRemoteDescription(e);const a=yield t.createAnswer();yield t.setLocalDescription(a),this.broadcastChannel.postMessage({type:"answer",sdp:a.sdp,dealerId:e.dealerId,clientId:e.clientId})}))}handleAnswer(e){var n;return o(this,void 0,void 0,(function*(){e.dealerId===this.id&&(null===(n=this._tabs.find((n=>n.id===e.clientId)))||void 0===n||n.peerConnection.setRemoteDescription(e))}))}handleCandidate(e){var n;if(e.candidate){if(e.clientId!==this.id)return;null===(n=this._tabs.find((n=>n.id===e.dealerId)))||void 0===n||n.peerConnection.addIceCandidate(e)}}handleClosing(e){var n;const t=this._tabs.find((n=>n.id===e.clientId));t&&(this._tabs=this._tabs.filter((e=>e!==t)),null===(n=this.onTabClose)||void 0===n||n.call(this,t),t.peerConnection.close())}createTab(n){const t=new RTCPeerConnection;t.onicecandidate=e=>{e.candidate&&this.broadcastChannel.postMessage({type:"candidate",candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex,dealerId:this.id,clientId:n})};const a=new e(t,n);return t.onconnectionstatechange=e=>{var n;"connected"!==t.connectionState&&"connecting"!==t.connectionState&&(this._tabs=this._tabs.filter((e=>e!==a)),null===(n=this.onTabClose)||void 0===n||n.call(this,a),t.close())},this._tabs.push(a),a}get tabs(){return this._tabs.filter((e=>"open"===e.dataChannel.readyState))}broadcast(e){this.tabs.forEach((n=>n.send(e)))}}const r=c.getInstance();let l;const h="#editor"===window.location.hash,p=h?document.body:document.createElement("div");let u;const f=[],b=e=>{if(h){const e=document.createElement("textarea");return e.placeholder="Type here...",p.appendChild(e),e}const n=document.createElement("div");p.appendChild(n);const t=document.createElement("label");t.innerHTML=`Tab ${(null==e?void 0:e.id)||"me"}`,n.appendChild(t);const a=document.createElement("textarea");return a.placeholder="Type here...",n.appendChild(a),a.oninput=()=>{e.send(JSON.stringify({type:"data",data:a.value}))},f[e.id]=n,a};r.onTabOpen=e=>{h||(u=b(e)),e.onmessage=n=>{const t=JSON.parse(n.data);"manager"===t.type&&(l=e,u.oninput=()=>{e.send(JSON.stringify({type:"data",data:u.value}))}),"data"===t.type&&(u.value=t.data)},h||e.send(JSON.stringify({type:"manager",data:"I am the manager"}))},r.onTabClose=e=>{h||f[e.id].remove()},window.onload=()=>{if(h)u=b(l);else{const e=document.createElement("a");e.innerHTML="+",e.href="#editor",e.target="_blank",document.body.appendChild(e),p.classList.add("editors"),document.body.appendChild(p)}}})();